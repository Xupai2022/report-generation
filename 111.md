# LLM Orchestrator 大纲生成（Outline Step）——新增需求说明

## 1. 背景与目标

当前项目已实现基本的 **Template → Data Prep → LLM 内容生成 → 校验 → 渲染** 流程，但缺少一个关键步骤：  
➡️ **基于模板的报告大纲（Outline / SlidePlan）生成能力。**

为了让报告结构 **更稳定、更可控**，并支撑未来的 **局部重写、章节级审计、结构校验**，现正式补充此需求。

---

## 2. 新增步骤：Outline Step

LLM Orchestrator 在生成每页内容之前，需增加一个明确的步骤：

generate_outline(template_descriptor, facts, options) → SlidePlan

**其职责是：**

- 基于模板描述符（Descriptor）
- 基于 Data Prep 输出的结构化 facts
- 可选：结合用户设置（audience、language 等）
- **生成一份结构化的大纲，用于指导后续逐页内容生成**

---

## 3. 输入数据要求

必须包含以下 3 类输入：

### ① 模板描述符 `template_descriptor`

来自 Template 模块，包括：

- `template_id`
- `slides` 数组：
  - `slide_no`
  - `slide_key`
  - `description`
- （可选）模板约束信息

---

### ② 结构化事实数据 `facts`

来自 Data Prep，包含但不限于：

- KPI
- 告警趋势
- Top 类别
- 事件信息
- 漏洞态势
- 云风险与暴露面
- 租户与周期信息
- 证据口径（evidence）

---

### ③ 生成选项 `options`

- `audience`: `"management"` / `"technical"`
- `language`: `"zh-CN"` 等
- `max_slides`: 限制本次生成幻灯片数量（可选）

---

## 4. Outline Step 输出结构：SlidePlan  
**（必须为严格的 JSON）**

模型返回格式必须为：

```json
{
  "template_id": "mss_management_light_v1",
  "slides": [
    {
      "slide_no": 1,
      "slide_key": "cover",
      "enabled": true,
      "title": "ACME 电子商务 MSS 月度安全报告",
      "intent": "封面，包含报告标题/客户名/周期",
      "fact_refs": [
        "tenant.name",
        "period",
        "report_meta.report_title"
      ]
    },
    {
      "slide_no": 2,
      "slide_key": "executive_summary",
      "enabled": true,
      "title": "本期安全态势概览",
      "intent": "面向管理层输出关键结论和建议",
      "fact_refs": [
        "alerts.total",
        "alerts.by_severity.high",
        "mss_ops.mttr_hours_avg",
        "alerts.top_categories"
      ]
    }
  ]
}
```json

### 4.2 约束说明

#### 4.2.1 模板一致性约束

- SlidePlan 中的 `slide_no` 与 `slide_key` **必须来自** `template_descriptor`
- **禁止**生成模板中不存在的页面
- **禁止**调整模板中定义的页面顺序
- `template_id` 必须与输入的模板描述符保持一致

#### 4.2.2 enabled 字段约束

- 模板中的固定必选页，`enabled` 默认值为 `true`
- 可选页面未来可通过策略或用户配置关闭
- Outline Step **不负责删除页面**
- 是否生成页面内容仅通过 `enabled` 字段控制

#### 4.2.3 fact_refs 字段约束

- `fact_refs` 必须是 `facts` 中真实存在的字段路径
- `fact_refs` 用于声明该页面内容生成所依赖的 **最小事实集合**
- 后续内容生成阶段 **仅允许**使用 `fact_refs` 指定的事实数据
- `fact_refs` 将用于：
  - 内容生成时的事实输入约束
  - 自动化事实校验
  - 审计与决策路径追溯
## 5. 后端行为调整

### 5.1 LLM Orchestrator 新流程

LLM Orchestrator 的整体流程调整为两个阶段。

第一阶段：Outline

SlidePlan = generate_outline(template_descriptor, facts, options)

第二阶段：Content

SlideSpec[] = generate_slide_content(
  SlidePlan.slides,
  facts,
  options
)

---

### 5.2 generate_slide_content 行为调整要求

- 按顺序遍历 SlidePlan.slides
- 仅对 enabled 为 true 的页面生成内容
- 根据每一页的 fact_refs 自动从 facts 中提取对应的事实子集
- 页面标题优先使用 SlidePlan 中定义的 title
- 禁止在内容生成阶段改变页面结构或新增页面

---

## 6. 持久化与调试要求

每一次报告生成，都必须持久化 Outline Step 的输出结果。

### 6.1 存储位置

backend/outputs/outline/<report_id>_slideplan.json

---

### 6.2 用途说明

- 调试模型结构化输出
- 支撑前端未来的大纲可视化能力
- 为局部重写提供上下文
- 审计时可查看 AI 的结构决策路径

---

### 6.3 异常处理要求

- 若 Outline 生成失败（JSON 格式错误、字段缺失、非法 slide_key）
- 必须立即终止流程
- 返回明确、可定位的错误信息
- 禁止进入内容生成阶段

---

## 7. 本需求带来的能力提升

- 报告结构不再依赖模型自由发挥，结构稳定且可控
- 每一页内容仅基于明确的事实子集生成，精度更高
- 前端可扩展章节级导航和大纲可视化能力
- 审计可明确追溯 AI 为什么生成某一页内容
- 支持单页或单章节重写，无需解析整份文档结构

